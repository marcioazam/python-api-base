name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/dependabot.yml"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/dependabot.yml"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - "LICENSE"
      - ".gitignore"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: ~/.cache/uv
  UV_VERSION: "0.5.0"

jobs:
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      should-skip: ${{ steps.skip-check.outputs.should_skip }}
    steps:
      - name: Check for skip
        id: skip-check
        uses: fkirc/skip-duplicate-actions@f75f66ce1886f00957d99748a42c724f4330bdcf # v5.3.1
        with:
          concurrent_skipping: "same_content_newer"
          skip_after_successful_duplicate: "true"

      - name: Checkout repository
        if: steps.skip-check.outputs.should_skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        if: steps.skip-check.outputs.should_skip != 'true'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        if: steps.skip-check.outputs.should_skip != 'true'
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        if: steps.skip-check.outputs.should_skip != 'true'
        run: uv sync --dev --frozen

      - name: Validate configurations
        if: steps.skip-check.outputs.should_skip != 'true'
        run: uv run python scripts/validate-config.py --strict

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate-config]
    if: needs.validate-config.outputs.should-skip != 'true'
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --dev --frozen

      - name: Run ruff check
        run: uv run ruff check . --output-format=github

      - name: Run ruff format check
        run: uv run ruff format --check .

      - name: Run mypy
        run: uv run mypy src/ --show-error-codes

      - name: Check file sizes
        run: uv run python scripts/check_file_sizes.py --fail-on-violation --max-lines 400

  test:
    name: Test (${{ matrix.python-version }}, ${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate-config]
    if: needs.validate-config.outputs.should-skip != 'true'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
        test-suite: ["unit", "properties", "integration"]
        exclude:
          - python-version: "3.11"
            test-suite: "properties"
          - python-version: "3.13"
            test-suite: "integration"

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"
          cache-suffix: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --dev --frozen

      - name: Run ${{ matrix.test-suite }} tests
        run: |
          case "${{ matrix.test-suite }}" in
            unit)
              uv run pytest tests/unit -v \
                --cov=src \
                --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
                --cov-report=html:htmlcov-${{ matrix.python-version }} \
                --cov-fail-under=80 \
                --junitxml=junit-${{ matrix.python-version }}.xml
              ;;
            properties)
              uv run pytest tests/properties -v \
                --hypothesis-seed=0 \
                --hypothesis-profile=ci \
                --junitxml=junit-properties-${{ matrix.python-version }}.xml
              ;;
            integration)
              uv run pytest tests/integration -v \
                --junitxml=junit-integration-${{ matrix.python-version }}.xml
              ;;
          esac
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          PYTHONDONTWRITEBYTECODE: "1"

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12' && matrix.test-suite == 'unit'
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          files: ./coverage-${{ matrix.python-version }}.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results-${{ matrix.python-version }}-${{ matrix.test-suite }}
          path: |
            junit-*.xml
            htmlcov-*/
          retention-days: 7

  build:
    name: Build & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test]
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          push: false
          load: true
          tags: my-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # v0.31.0
        with:
          image-ref: my-api:${{ github.sha }}
          format: "sarif"
          output: "trivy-image-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "1"

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@fe4161a26a8629af62121b670040955b330f9af2 # v3.28.0
        with:
          sarif_file: "trivy-image-results.sarif"
          category: "trivy-image"

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "::error::CI pipeline failed"
            exit 1
          fi
          echo "::notice::CI pipeline completed successfully"
