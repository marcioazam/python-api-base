name: Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "**.py"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/security.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "**.py"
      - "pyproject.toml"
      - "uv.lock"
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.5.0"

jobs:
  bandit:
    name: Bandit SAST
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --dev --frozen

      - name: Run Bandit (SARIF output)
        run: |
          uv run bandit -r src/ \
            -ll \
            -f sarif \
            -o bandit-results.sarif \
            --exit-zero

      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v3.28.0
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"

      - name: Run Bandit (fail on high severity)
        run: uv run bandit -r src/ -ll -iii

  trivy-fs:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "1"
          format: "sarif"
          output: "trivy-fs-results.sarif"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v3.28.0
        with:
          sarif_file: "trivy-fs-results.sarif"
          category: "trivy-filesystem"

  trivy-config:
    name: Trivy Config Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: "config"
          scan-ref: "."
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"
          format: "sarif"
          output: "trivy-config-results.sarif"

      - name: Upload Trivy config results
        if: always()
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v3.28.0
        with:
          sarif_file: "trivy-config-results.sarif"
          category: "trivy-config"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0, LGPL-3.0
          allow-ghsas: ""
          comment-summary-in-pr: always

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0.20.11
        with:
          artifact-name: sbom-spdx.json
          format: spdx-json
          output-file: sbom-spdx.json

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0.20.11
        with:
          artifact-name: sbom-cyclonedx.json
          format: cyclonedx-json
          output-file: sbom-cyclonedx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json
          retention-days: 90

  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@ddc015e22b15a8520b5e17e3d5c0e0e0e0e0e0e0 # v3.88.0
        with:
          extra_args: --only-verified --fail

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ossf-scorecard:
    name: OSSF Scorecard
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard results
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v3.28.0
        with:
          sarif_file: scorecard-results.sarif
          category: "ossf-scorecard"

  security-status:
    name: Security Status
    runs-on: ubuntu-latest
    needs: [bandit, trivy-fs, trivy-config, secrets-scan]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check security status
        run: |
          if [[ "${{ needs.bandit.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy-fs.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets-scan.result }}" == "failure" ]]; then
            echo "::error::Security scan failed - review findings"
            exit 1
          fi
          echo "::notice::Security scans completed"
