name: Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "**.py"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/security.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "**.py"
      - "pyproject.toml"
      - "uv.lock"
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.5.0"

jobs:
  bandit:
    name: Bandit SAST
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --dev --frozen

      - name: Run Bandit (SARIF output)
        run: |
          uv run bandit -r src/ \
            -ll \
            -f sarif \
            -o bandit-results.sarif \
            --exit-zero

      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3.28.0
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"

      - name: Run Bandit (fail on high severity)
        run: uv run bandit -r src/ -ll -iii

  trivy-fs:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # v0.31.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "1"
          format: "sarif"
          output: "trivy-fs-results.sarif"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3.28.0
        with:
          sarif_file: "trivy-fs-results.sarif"
          category: "trivy-filesystem"

  trivy-config:
    name: Trivy Config Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # v0.31.0
        with:
          scan-type: "config"
          scan-ref: "."
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"
          format: "sarif"
          output: "trivy-config-results.sarif"

      - name: Upload Trivy config results
        if: always()
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3.28.0
        with:
          sarif_file: "trivy-config-results.sarif"
          category: "trivy-config"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4.7.1
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0, LGPL-3.0
          allow-ghsas: ""
          comment-summary-in-pr: always

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          artifact-name: sbom-spdx.json
          format: spdx-json
          output-file: sbom-spdx.json

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0.20.0
        with:
          artifact-name: sbom-cyclonedx.json
          format: cyclonedx-json
          output-file: sbom-cyclonedx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json
          retention-days: 90

  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@ddc015e22b15a8520b5e17e3d5c0e0e0e0e0e0e0 # v3.88.0
        with:
          extra_args: --only-verified --fail

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ossf-scorecard:
    name: OSSF Scorecard
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186 # v2.4.1
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard results
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3.28.0
        with:
          sarif_file: scorecard-results.sarif
          category: "ossf-scorecard"

  security-status:
    name: Security Status
    runs-on: ubuntu-latest
    needs: [bandit, trivy-fs, trivy-config, secrets-scan]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check security status
        run: |
          if [[ "${{ needs.bandit.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy-fs.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets-scan.result }}" == "failure" ]]; then
            echo "::error::Security scan failed - review findings"
            exit 1
          fi
          echo "::notice::Security scans completed"
