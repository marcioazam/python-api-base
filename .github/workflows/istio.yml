name: Istio Manifest Validation

on:
  pull_request:
    paths:
      - "deployments/istio/**"
      - "tests/properties/test_istio_manifests.py"
      - ".github/workflows/istio.yml"
  push:
    branches: [main, develop]
    paths:
      - "deployments/istio/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  ISTIO_VERSION: "1.23.0"
  PYTHON_VERSION: "3.12"

jobs:
  validate:
    name: Istio Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install istioctl
        run: |
          curl -sL https://istio.io/downloadIstio | ISTIO_VERSION=${{ env.ISTIO_VERSION }} sh -
          sudo mv istio-${{ env.ISTIO_VERSION }}/bin/istioctl /usr/local/bin/
          istioctl version --remote=false

      - name: Validate Istio manifests (base)
        run: |
          istioctl analyze deployments/istio/base/ \
            --use-kube=false \
            --output-threshold=Warning || true

      - name: Validate YAML syntax
        run: |
          for file in deployments/istio/base/*.yaml; do
            echo "Validating $file"
            python -c "import yaml; list(yaml.safe_load_all(open('$file')))" || exit 1
          done

  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pytest hypothesis pyyaml

      - name: Run property-based tests
        run: |
          pytest tests/properties/test_istio_manifests.py \
            -v \
            --tb=short \
            --hypothesis-seed=0

  kustomize-build:
    name: Kustomize Build (${{ matrix.overlay }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        overlay: [dev, staging, prod]
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Build ${{ matrix.overlay }} overlay
        run: |
          if [ -d "deployments/istio/overlays/${{ matrix.overlay }}" ]; then
            kustomize build deployments/istio/overlays/${{ matrix.overlay }} > /tmp/istio-${{ matrix.overlay }}.yaml
            echo "Built ${{ matrix.overlay }} overlay successfully"
          else
            echo "Overlay ${{ matrix.overlay }} not found, skipping"
          fi

      - name: Upload built manifests
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: istio-manifests-${{ matrix.overlay }}
          path: /tmp/istio-*.yaml
          retention-days: 5
          if-no-files-found: ignore
